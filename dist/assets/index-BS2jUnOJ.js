import{r as g,j as e,P as k,F as f,T as d,S as P,B as C,V as G,a2 as H,a3 as N,a4 as $,H as z,av as K,aw as U,p as J,a5 as V,aK as Q,aL as q,aM as X,aN as Y,aA as Z,aB as ee,aC as se,M as ne,aO as te,y as re,aa as M}from"./index-kAqiC6k2.js";import{T as x,C as ie,I as ae,A as ce}from"./AdminProtectedBodyLayout-Di-Ms30s.js";import{I as oe}from"./IconCheck-OBFlQm04.js";import{G as le,a as W}from"./Grid-pDSbpdFy.js";import{I as de,a as ue}from"./IconChevronUp-CMq190hU.js";const he={FIRST:0,SECOND:1,THIRD:2,FOURTH:3,FIFTH:4},ge=({data:t,isLoadingMark:l,handleSubmit:i})=>{var S;const[s,o]=g.useState([]),[p,y]=g.useState(!1);return g.useEffect(()=>{t&&o(t.map(r=>{var n;return{id:r.project.id,name:`${r.project.groupName} - ${r.project.title}`,isSelected:(n=r.project)!=null&&n.rank?he[r.project.rank]:null}}))},[t]),e.jsx("form",{children:e.jsx(k,{radius:"lg",p:"sm",children:e.jsxs(f,{direction:"column",gap:"md",miw:360,children:[...Array(5).fill(0).map((r,n)=>{var u;const a=((u=s==null?void 0:s.find(c=>c.isSelected===n))==null?void 0:u.id.toString())??null;return e.jsxs(f,{direction:"column",gap:"xs",children:[e.jsxs(f,{gap:"xs",align:"center",children:[e.jsx(d,{size:"lg",style:{minWidth:40},c:n<3?"auto":"gray.6",ta:"center",children:E(n)}),e.jsx(d,{size:"lg",variant:n<3?"gradient":"text",gradient:{from:"#0036D0",to:"#B31010",deg:45},children:L(n)})]}),e.jsx(P,{checkIconPosition:"left",data:s==null?void 0:s.map(c=>({value:c==null?void 0:c.id.toString(),label:c.name,disabled:c.isSelected!==null&&c.isSelected!==n})),placeholder:"Pick winners",size:"md",readOnly:p,...p?{rightSection:e.jsx(oe,{}),variant:"unstyled"}:{},value:a,onChange:c=>{if(console.log("_value",c),c===null){o(s==null?void 0:s.map(h=>h.isSelected===n?(console.log("item.isSelected === idx",h.isSelected===n,n,h.isSelected),{...h,isSelected:null}):h));return}o((s==null?void 0:s.map(h=>h.isSelected===n?{...h,isSelected:null}:h.id===Number(c)?{...h,isSelected:n}:h))??[])},clearable:!0})]},L(n))}),e.jsxs(le,{children:[e.jsx(W,{span:12,ta:"left",children:e.jsxs(f,{gap:"sm",align:"center",children:[e.jsx(d,{w:60,size:"lg",children:E(0)}),e.jsx(d,{size:"lg",children:((S=s==null?void 0:s.find(r=>r.isSelected===0))==null?void 0:S.name)??""})]})}),...Array(4).fill(0).map((r,n)=>{var a;return e.jsx(W,{span:12,ta:"left",children:e.jsxs(f,{gap:"sm",align:"center",children:[e.jsxs(d,{c:n>1?"gray.7":"auto",w:60,size:"lg",children:[n>1?"NO. ":"",E(n+1)]}),e.jsx(d,{size:"lg",children:((a=s==null?void 0:s.find(u=>u.isSelected===n+1))==null?void 0:a.name)??""})]})},n)})]}),p?e.jsxs(e.Fragment,{children:[e.jsx(C,{mt:"md",size:"compact-lg",onClick:()=>y(!1),type:"button",variant:"outline",children:"Edit"}),e.jsx(G,{children:e.jsx(C,{type:"submit",children:"Hidden"})})]}):e.jsx(C,{mt:"md",size:"compact-lg",onClick:()=>{var r;y(!0),i==null||i(((r=s==null?void 0:s.sort((n,a)=>n.isSelected-a.isSelected))==null?void 0:r.map(n=>n.id))??[])},loading:l,children:"Submit"})]})})})},L=t=>{switch(t){case 0:return"First place";case 1:return"Second place";case 2:return"Third place";case 3:return"Fourth place";default:return"Fifth place"}},E=t=>{switch(t){case 0:return"ðŸ¥‡";case 1:return"ðŸ¥ˆ";case 2:return"ðŸ¥‰";case 3:return"4";default:return"5"}},pe="_th_1w9xk_1",je="_control_1w9xk_5",xe="_icon_1w9xk_17",v={th:pe,control:je,icon:xe};function I({children:t,reversed:l,sorted:i,onSort:s,...o}){const p=i?l?de:ue:ae;return e.jsx(x.Th,{...o,className:v.th,children:e.jsx($,{onClick:s,className:v.control,children:e.jsxs(z,{justify:"space-between",children:[e.jsx(d,{fw:500,fz:"sm",children:t}),s?e.jsx(ie,{className:v.icon,children:e.jsx(p,{style:{width:N(16),height:N(16)},stroke:1.5})}):e.jsx(e.Fragment,{})]})})})}function O(t,l){const i=l.toLowerCase().trim(),s=["groupName","title"];return t.filter(o=>s.some(p=>o.project[p].toLowerCase().includes(i)))}function fe(t,l){const{sortBy:i}=l;return O(i?[...t].sort((s,o)=>l.reversed?o.project[i].localeCompare(s.project[i]):s.project[i].localeCompare(o.project[i])):t,l.search)}function me({data:t}){const[l]=g.useState(""),[i,s]=g.useState(t),[o,p]=g.useState(null),[y,S]=g.useState(!1),r=a=>{const u=a===o?!y:!1;S(u),p(a),s(fe(t??[],{sortBy:a,reversed:u,search:l}))},n=i==null?void 0:i.map(a=>{var u;return e.jsxs(x.Tr,{children:[e.jsx(x.Td,{children:a.project.averageMarkV2}),e.jsx(x.Td,{children:e.jsxs(f,{direction:"column",gap:"xs",children:[e.jsx(d,{size:"md",children:a.project.title}),e.jsx(d,{size:"sm",c:"gray",children:a.project.groupName})]})}),e.jsx(x.Td,{children:(u=a==null?void 0:a.judgesMarked)==null?void 0:u.map(c=>`${c.firstName} ${c.lastName}`).join(", ")})]},a.project.id)});return g.useEffect(()=>{s(t)},[t]),e.jsx(H,{children:e.jsx(k,{children:e.jsxs(x,{horizontalSpacing:"md",verticalSpacing:"xs",children:[e.jsx(x.Tbody,{children:e.jsxs(x.Tr,{children:[e.jsx(I,{style:{width:N(80)},ta:"center",children:"Scores"}),e.jsx(I,{sorted:o==="title",reversed:y,onSort:()=>r("title"),children:"Projects"}),e.jsx(I,{children:"Marked by"})]})}),e.jsx(x.Tbody,{children:n!=null&&n.length?n:e.jsx(x.Tr,{children:e.jsx(x.Td,{colSpan:3,children:e.jsx(d,{fw:500,ta:"center",children:"Nothing found"})})})})]})})})}const be=()=>{const[t,l]=K(),[i,s]=g.useState(!1),o=U(),p="https://nhatphi-nginx.io.vn:8888/api/ws",[y,{toggle:S}]=J();g.useEffect(()=>{l({tab:(t==null?void 0:t.get("tab"))??"projects"})},[]);const{semesterId:r}=V(),{data:n,isLoading:a,refetch:u}=Q(r,{skip:!r,refetchOnMountOrArgChange:!0}),{data:c}=q(r,{skip:!r,pollingInterval:1e3*10}),[h,{isLoading:T}]=X(),R=async()=>{var w;try{await _({semesterId:r,name:r}).unwrap()}catch(j){M.show({title:"Error",message:((w=j==null?void 0:j.data)==null?void 0:w.message)??"",color:"red"})}},D=async w=>{var j;try{await h({id:r,body:w}).unwrap(),S(),await new Promise(m=>setTimeout(m,3e3)),s(!0)}catch(m){M.show({title:"Error",message:((j=m==null?void 0:m.data)==null?void 0:j.message)??"",color:"red"})}},[_,{isLoading:B}]=Y();return g.useEffect(()=>{c&&s(c.round2Closed)},[c]),g.useEffect(()=>{const w=new Z(p),j=new ee({webSocketFactory:()=>w,debug:m=>console.log(m),reconnectDelay:5e3,heartbeatIncoming:4e3,heartbeatOutgoing:4e3});return j.onConnect=()=>{console.log("WebSocket connected"),j.subscribe("/notifications",m=>{const A=JSON.parse(m.body??"{}"),{content:F}=A;if(F){const b=JSON.parse(F??"{}");console.log("result",b),b&&(o(se(b)),u())}console.log(A)})},j.activate(),()=>{j.deactivate()}},[u]),e.jsxs(ce,{title:"Final result",loadingOverlay:a,children:[e.jsxs(f,{gap:"sm",justify:"space-between",style:{width:"100%"},children:[e.jsxs(f,{direction:"column",gap:"xs",children:[e.jsx(k,{p:"sm",children:e.jsx(d,{fw:500,children:"Current results"})}),e.jsx(k,{p:"sm",style:{minWidth:700},children:e.jsx(me,{data:n??[]})})]}),e.jsxs(f,{direction:"column",gap:"xs",children:[e.jsx(k,{p:"sm",children:e.jsxs(z,{justify:"space-between",children:[e.jsx(d,{fw:500,children:"Assign winners"}),e.jsx(C,{size:"xs",loading:B,disabled:!i,onClick:R,children:"Export winners"})]})}),e.jsx(k,{p:"sm",children:e.jsx(ge,{data:n,isLoadingMark:T,handleSubmit:D})})]})]}),e.jsx(ne,{opened:y,onClose:S,title:"Export winners",size:"sm",children:e.jsxs(f,{direction:"column",gap:"sm",children:[e.jsx(d,{children:"Winners chosen successfully. Would you like to download the file of winners?"}),e.jsx(C,{loaderProps:{children:e.jsxs(z,{align:"center",justify:"center",children:[e.jsx(d,{size:"sm",children:"Generating file"}),e.jsx(te,{color:"white",type:"dots",size:"sm"})]})},loading:!i,onClick:async()=>{await R(),re.closeAll()},children:"Download file"})]})})]})};export{be as default};
